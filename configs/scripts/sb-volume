#!/bin/bash

# Fetch the current volume as a percentage
get_volume() {
    wpctl get-volume @DEFAULT_AUDIO_SINK@ | awk '{print int($2 * 100)}'
}

# Fetch the mute status
is_muted() {
    wpctl get-mute @DEFAULT_AUDIO_SINK@ | awk '{print $2}'
}

# Fetch the microphone mute status
is_mic_muted() {
    wpctl get-mute @DEFAULT_AUDIO_SOURCE@ | awk '{print $2}'
}

# Determine the volume icon
get_icon() {
    local volume=$(get_volume)
    local mute=$(is_muted)

    if [ "$mute" == "true" ]; then
        echo "üîá"  # Mute icon
    elif [ "$volume" -eq 0 ]; then
        echo "üîà"  # Low volume icon
    elif [ "$volume" -lt 33 ]; then
        echo "üîâ"  # Medium volume icon
    elif [ "$volume" -lt 67 ]; then
        echo "üîä"  # High volume icon
    elif [ "$volume" -le 100 ]; then
        echo "üì¢"  # Very high volume icon
    else
        echo "üì£"  # Maximum volume icon (for over 100%)
    fi
}

# Determine the microphone icon
get_mic_icon() {
    local mute=$(is_mic_muted)

    if [ "$mute" == "true" ]; then
        echo "üéôÔ∏è"  # Mic mute icon
    else
        echo "üé§"  # Mic unmute icon
    fi
}

# Handle different actions based on arguments
case "$1" in
    --getvolume)
        get_volume
        ;;
    --geticon)
        get_icon
        ;;
    --getmicicon)
        get_mic_icon
        ;;
    --inc)
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%+
        pkill -RTMIN+10 dwmblocks
        ;;
    --dec)
        wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-
        pkill -RTMIN+10 dwmblocks
        ;;
    --toggle)
        wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
        pkill -RTMIN+10 dwmblocks
        ;;
    --togglemic)
        wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle
        pkill -RTMIN+11 dwmblocks
        ;;
    *)
        # Handle mouse click actions
        case "$BLOCK_BUTTON" in
            1)  # Left click (volume)
                setsid -f "$TERMINAL" -e helvum
                ;;
            3)  # Right click (volume)
                wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle
                pkill -RTMIN+10 dwmblocks
                ;;
            4)  # Scroll up (increase volume)
                wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%+
                pkill -RTMIN+10 dwmblocks
                ;;
            5)  # Scroll down (decrease volume)
                wpctl set-volume @DEFAULT_AUDIO_SINK@ 5%-
                pkill -RTMIN+10 dwmblocks
                ;;
        esac
        ;;
esac

# Output the volume and microphone icons
echo "$(get_icon) $(get_mic_icon)"
